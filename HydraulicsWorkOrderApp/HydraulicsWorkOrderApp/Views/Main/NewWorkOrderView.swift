//
//  NewWorkOrderView.swift
//  HydraulicsWorkOrderApp
//
//  Created by Bec Archer on 8/8/25.
//
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// üìÑ NewWorkOrderView.swift
// Customer lookup + inline WO_Item forms, with NewCustomerModal sheet
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

import SwiftUI
import FirebaseFirestore
import FirebaseFirestoreSwift

struct NewWorkOrderView: View {
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    @State private var selectedCustomer: Customer?
    @State private var searchText: String = ""
    @State private var matchingCustomers: [Customer] = []
    @State private var flagged: Bool = false
    @State private var items: [WO_Item] = [WO_Item.blank()]
    @State private var showAlert: Bool = false
    @State private var alertMessage: String = ""
    @State private var expandedIndex: Int? = nil
    @State private var showingNewCustomerModal: Bool = false   // ‚úÖ fixed: had no Bool type
    @State private var isPickingCustomer = false
    @State private var searchDebounce: DispatchWorkItem?
    @State private var showSaveBanner: Bool = false
    @State private var savedWONumber: String = ""
    @ObservedObject private var customerDB = CustomerDatabase.shared
    
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Prefill Helpers (derive from searchText) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private var prefillNameFromSearch: String {
        let trimmed = searchText.trimmingCharacters(in: .whitespacesAndNewlines)
        let digits = trimmed.filter(\.isNumber)
        return digits.count >= 3 ? "" : trimmed   // numbers ‚áí phone, else ‚áí name
    }
    private var prefillPhoneFromSearch: String {
        let trimmed = searchText.trimmingCharacters(in: .whitespacesAndNewlines)
        let digits = trimmed.filter(\.isNumber)
        return digits.count >= 3 ? trimmed : ""   // digits ‚áí phone, else blank
    }
    @Environment(\.dismiss) private var dismiss
    @EnvironmentObject var appState: AppState

    // END Prefill Helpers


    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BODY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var body: some View {
        NavigationStack {
            Form {
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CUSTOMER LOOKUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                Section(header: Text("Customer Lookup")) {
                    // CANCEL BUTTON INLINE
                    if let customer = selectedCustomer {
                        // Selected customer summary card with inline Clear button (compact layout)
                        HStack(alignment: .center, spacing: 8) {
                            VStack(alignment: .leading, spacing: 2) { // ‚Üì tighter vertical spacing
                                Text(customer.name)
                                    .font(.headline)
                                Text(customer.phone)
                                    .font(.subheadline)
                                    .foregroundStyle(.secondary)
                            }
                            Spacer()
                            Button {
                                selectedCustomer = nil
                                searchText = ""
                            } label: {
                                Image(systemName: "xmark.circle.fill")
                                    .foregroundColor(.red)
                                    .imageScale(.large)
                                    .padding(.leading, 4)
                                    .accessibilityLabel("Clear selected customer")
                            }
                        }
                        .padding(.vertical, 4)
                        // END CANCEL BUTTON INLINE
                    } else {
                        // Search + results + Add New button
                        VStack(alignment: .leading) {
                            
                            // ----- CUSTOMER LOOKUP (INSIDE THE SECTION) -----
                            TextField("Search by name or phone", text: $searchText)
                                .textFieldStyle(.roundedBorder)
                                .disabled(isPickingCustomer) // ‚Üê prevent live search while selecting

                            if !matchingCustomers.isEmpty {
                                ForEach(matchingCustomers.indices, id: \.self) { idx in
                                    let customer = matchingCustomers[idx]
                                    Button {
                                        // Freeze updates during selection
                                        isPickingCustomer = true

                                        // Commit selection deterministically
                                        selectCustomer(customer)

                                        // Clear list immediately so no diffing can fire
                                        matchingCustomers = []
                                        searchText = ""

                                        // Unfreeze on next runloop
                                        DispatchQueue.main.async { isPickingCustomer = false }

                                        // (Optional) debug
                                        print("üëÜ PICKED (idx \(idx)):", customer.id.uuidString, customer.name, customer.phone)
                                    } label: {
                                        VStack(alignment: .leading, spacing: 2) {
                                            Text(customer.name)
                                            Text(customer.phone)
                                                .font(.caption)
                                                .foregroundStyle(.secondary)
                                        }
                                        .padding(.vertical, 4)
                                        .contentShape(Rectangle()) // nice big tap target
                                    }
                                    .buttonStyle(.plain)
                                }
                            } else if !searchText.isEmpty {
                                Button {
                                    showingNewCustomerModal = true
                                } label: {
                                    Label("Add New Customer", systemImage: "plus.circle")
                                        .foregroundStyle(.blue)
                                }
                                .padding(.top, 4)
                            }
//  --------- END HERE ---------------
                            // END VALIDATE ME??
                        }
                    }
                }
                .listRowInsets(EdgeInsets(top: 6, leading: 16, bottom: 6, trailing: 16)) // ‚Üì tighter bottom spacing

                // END Customer Lookup
                
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ WORK ORDER FLAGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                Section(header: Text("Work Order Info")) {
                    Toggle("Flag this WorkOrder", isOn: $flagged)
                }
                // END Work Order Flags
                .listRowInsets(EdgeInsets(top: 6, leading: 16, bottom: 6, trailing: 16)) // ‚Üì tighter top spacing
                
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ WO_Item ENTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                Section(header: Text("Equipment Items")) {
                    ForEach(items.indices, id: \.self) { idx in
                        WOItemAccordionRow(
                            index: idx,
                            items: $items,
                            expandedIndex: $expandedIndex,
                            onDelete: handleDeleteWOItem
                        )
                    }


                    Button {
                        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Add & Expand New Item (atomic animation) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        withAnimation { // use default animation for iOS 16/17 safety
                            let insertIndex = items.count
                            let newItem = WO_Item.blank()
                            expandedIndex = nil            // collapse current
                            items.append(newItem)          // append new
                            expandedIndex = insertIndex    // expand the new one
                        }
                        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ END Add & Expand New Item ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                    } label: {
                        Label("Add Another Item", systemImage: "plus.circle")
                    }

                }

                // END WO_Item Entry
                
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                Section {
                    Button("‚úÖ Save Work Order") {
                        saveWorkOrder {
                            AppState.shared.currentView = .activeWorkOrders  // ‚¨ÖÔ∏è Navigate to Active
                        }
                    }
                }
                // END Save

            }
            .navigationTitle("New Work Order")
            .alert(Text("Status"), isPresented: $showAlert) {
                Button("OK", role: .cancel) {}
            } message: {
                Text(alertMessage)
            }
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SAFE ONCHANGE FOR iOS 16+17 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Debounced onChange (prevents list swapping mid‚Äëtap) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            .onChange(of: searchText) { _, newValue in
                print("üîÅ onChange: searchText updated to '\(newValue)'")
                guard !isPickingCustomer else { return }
                searchDebounce?.cancel()
                let task = DispatchWorkItem { handleSearchTextChange(newValue) }
                searchDebounce = task
                DispatchQueue.main.asyncAfter(deadline: .now() + 0.2, execute: task)
            }
            // END Debounced onChange
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DIAGNOSTIC: Who is overwriting selectedCustomer? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            .onChange(of: selectedCustomer) { _, newValue in
                guard let c = newValue else { return }
                print("‚ö†Ô∏è selectedCustomer CHANGED:", c.id.uuidString, c.name, c.phone)

                // Prevent triggering another change if already empty
                if !searchText.isEmpty {
                    print("üßπ Clearing searchText")
                    searchText = ""
                }

                if !matchingCustomers.isEmpty {
                    print("üßπ Clearing matchingCustomers")
                    matchingCustomers = []
                }
            }


            // END Diagnostic
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CUSTOMER INJECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            // üîÅ Customer injected from NewCustomerModalView
            .onChange(of: selectedCustomer) { _, newValue in
                guard let c = newValue else { return }
                print("‚ö†Ô∏è selectedCustomer CHANGED:", c.id.uuidString, c.name, c.phone)

                // Prevent triggering another change if already empty
                if !searchText.isEmpty {
                    print("üßπ Clearing searchText")
                    searchText = ""
                }

                if !matchingCustomers.isEmpty {
                    print("üßπ Clearing matchingCustomers")
                    matchingCustomers = []
                }
            }



            .onAppear {
                // Prefetch customers once for fast local filtering
                customerDB.fetchCustomers()

                if expandedIndex == nil {
                    expandedIndex = items.indices.first
                }
            }


            // END onChange
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Toast Banner Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            .overlay(
                Group {
                    if showSaveBanner {
                        VStack {
                            Spacer()
                            Text("‚úÖ WO-\(savedWONumber) Saved!")
                                .font(.subheadline)
                                .padding(.horizontal, 16)
                                .padding(.vertical, 10)
                                .background(Color.green.opacity(0.95))
                                .foregroundColor(.white)
                                .cornerRadius(12)
                                .shadow(radius: 4)
                                .padding(.bottom, 30)
                                .transition(.move(edge: .bottom).combined(with: .opacity))
                                .animation(.easeInOut(duration: 0.3), value: showSaveBanner)
                        }
                    }
                }
            )
            // END overlay

            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ New Customer Modal Sheet (attached to NavigationStack) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            .sheet(isPresented: $showingNewCustomerModal) {
                NewCustomerModalView(
                    prefillName: prefillNameFromSearch,
                    prefillPhone: prefillPhoneFromSearch,
                    selectedCustomer: $selectedCustomer
                )
            }
            // END sheet
        } // END NavigationStack
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ New Customer Modal Sheet (attached to NavigationStack) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        .sheet(isPresented: $showingNewCustomerModal) {
            NewCustomerModalView(
                prefillName: prefillNameFromSearch,
                prefillPhone: prefillPhoneFromSearch,
                selectedCustomer: $selectedCustomer
            )
        }
        // END sheet
    }
    // END .body
    
    
    
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SEARCH HANDLER (Cached Filter + Stable IDs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private func handleSearchTextChange(_ newValue: String) {
        let trimmed = newValue.trimmingCharacters(in: .whitespacesAndNewlines)
        guard !trimmed.isEmpty else {
            matchingCustomers = []
            return
        }

        // Normalize: digits-only for phone comparisons
        func digits(_ s: String) -> String { s.filter(\.isNumber) }
        let qLower = trimmed.lowercased()
        let qDigits = digits(trimmed)

        // Filter cached list
        let filtered = customerDB.customers.filter { c in
            let nameHit = c.name.lowercased().contains(qLower)
            let phoneHit: Bool = {
                if qDigits.isEmpty { return false }
                return digits(c.phone).contains(qDigits)
            }()
            return nameHit || phoneHit
        }

        // De-duplicate by id (some datasets can surface dupes after formatting)
        var seen = Set<UUID>()
        let unique = filtered.filter { seen.insert($0.id).inserted }

        // Stable sort: by name, then phone
        let sorted = unique.sorted {
            if $0.name.caseInsensitiveCompare($1.name) == .orderedSame {
                return $0.phone < $1.phone
            }
            return $0.name.localizedCaseInsensitiveCompare($1.name) == .orderedAscending
        }

        matchingCustomers = Array(sorted.prefix(25))
    }
    // END Search Handler

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Selection Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private func selectCustomer(_ customer: Customer) {
        withTransaction(Transaction(animation: .none)) {
            selectedCustomer = customer
            searchText = ""         // makes the list disappear
        }
        // TEMP: diagnostics so we can see if anyone overwrites later
        print("‚úÖ selectCustomer:", customer.id.uuidString, customer.name, customer.phone)
    }
    // END Selection Helper

    
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SAVE HANDLER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    func saveWorkOrder(onSuccess: (() -> Void)? = nil) {
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Required Field Validation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        guard let customer = selectedCustomer else {
            alertMessage = "Please select or add a Customer before saving this WorkOrder."
            showAlert = true
            return
        }
        // END: Required Field Validation

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Build WorkOrder (ALL required fields) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // NOTE: Placeholder values where we haven't wired managers yet.
        // - createdBy / lastModifiedBy will come from UserManager
        // - dropdownSchemaVersion hard-coded to 1 until DropdownSchema exists
        let wo = WorkOrder(
            id: UUID().uuidString,            // if your model uses String; otherwise keep UUID()
            createdBy: "Tech",                // ‚¨ÖÔ∏è move this up, right after id
            customerId: customer.id.uuidString,
            customerName: customer.name,
            customerPhone: customer.phone,
            WO_Type: "Intake",
            imageURL: items.first?.imageUrls.first,
            timestamp: Date(),
            status: "Checked In",
            WO_Number: generateLocalWONumber(),
            flagged: flagged,
            tagId: nil,
            estimatedCost: nil,
            finalCost: nil,
            dropdowns: [:],
            dropdownSchemaVersion: 1,
            lastModified: Date(),
            lastModifiedBy: "Tech",
            tagBypassReason: nil,
            isDeleted: false,
            notes: [],
            items: items        )


        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ END Build WorkOrder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Persist to Firestore (Codable) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        do {
            let db = Firestore.firestore()
            try db.collection("workOrders")
                .document(wo.id ?? UUID().uuidString)   // unwrap: ensure non-optional doc id
                .setData(from: wo)
            
            // If a success callback was provided (e.g., to dismiss), call it.
            // Otherwise show the success alert (useful for unit/UI testing).
            savedWONumber = wo.WO_Number
            showSaveBanner = true

            // Wait ~2 sec, then call the success callback (which routes away)
            DispatchQueue.main.asyncAfter(deadline: .now() + 2.0) {
                onSuccess?()
            }

            // (Optional) Reset local form state for the next intake (kept as-is)
            selectedCustomer = nil
            searchText = ""
            matchingCustomers = []
            flagged = false
            items = [WO_Item.blank()]
            expandedIndex = 0


        } catch {
            alertMessage = "‚ùå Failed to save WorkOrder: \(error.localizedDescription)"
            showAlert = true
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ END Persist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    }
    // END Save Handler

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Helper: Local WO Number (temp) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private func generateLocalWONumber() -> String {
        // Format: YYMMDD-### (temp counter = seconds mod 1000 to avoid collisions in dev)
        let df = DateFormatter()
        df.dateFormat = "yyMMdd"
        let day = df.string(from: Date())
        let suffix = String(format: "%03d", Int(Date().timeIntervalSince1970) % 1000)
        return "\(day)-\(suffix)"
    }
    // END Helper



    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Action: Delete / Reset WO_Item ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    private func handleDeleteWOItem(_ index: Int) {
        if items.count > 1 {
            _ = withAnimation { items.remove(at: index) }   // ignore return explicitly
            // Keep expansion on a sensible neighbor
            if let current = expandedIndex, current == index {
                expandedIndex = max(0, min(index, items.count - 1))
            } else if let current = expandedIndex, current > index {
                expandedIndex = current - 1
            }
        } else {
            // Must always have ‚â• 1 WO_Item: reset the lone item
            withAnimation { items[0] = WO_Item.blank() }   // ignore return explicitly
            expandedIndex = 0
        }
    }
    // END: Delete / Reset WO_Item

}
// END struct

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#Preview {
    NewWorkOrderView()
}
// END Preview
